(function(){var t,e,n,i,r,s,o,u=function(t,e){return function(){return t.apply(e,arguments)}},a=function(t,e){function n(){this.constructor=t}for(var i in e)c.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},c={}.hasOwnProperty;n=function(t){return $(".prompt").hide(),$("#error").text(t).slideDown()},i=function(t){return $(".prompt").hide(),$("#info").text(t).slideDown()},e=function(t,e){return"Basic "+encodeBase64(t+":"+e)},o=function(t,e){var n;return n=Date.now(),jQuery.ajax({type:"GET",url:t+"",processData:!0,data:{rnd:Math.random()},success:function(t,i,r){var s,o,u;return u=parseInt(r.getResponseHeader("content-length")),s=Date.now()-n,o=(u/s).toFixed(2),e(s,o)},error:function(t,i,r){var s,o,u;return 0===t.status?e(-1,-1):(u=parseInt(t.getResponseHeader("content-length")),s=Date.now()-n,o=(u/s).toFixed(2),e(s,o))}})},s=function(t,e){var n,i,r,s;return i=new Image,s=Date.now(),n=!1,i.onload=function(){var t,i;if(!n)return n=!0,t=Date.now()-s,i=(128e3/t).toFixed(2),e(t,i)},i.onerror=function(){return n?void 0:(n=!0,e(-1,-1))},setTimeout(function(){return n?void 0:(n=!0,e(-1,-1))},4e4),r=t+"?rnd="+Math.random(),i.src=r},t=function(t){function i(){this.startSpeedTest=u(this.startSpeedTest,this),this.updateState=u(this.updateState,this),this.updatePaveoProfileList=u(this.updatePaveoProfileList,this),this.checkSecretMode=u(this.checkSecretMode,this),this.setPaveoDefault=u(this.setPaveoDefault,this),this.purgeProfiles=u(this.purgeProfiles,this),this.fetchPaveo=u(this.fetchPaveo,this),this.batchAddProfile=u(this.batchAddProfile,this),this.exitSettingsPage=u(this.exitSettingsPage,this),this.saveGlobalSettings=u(this.saveGlobalSettings,this),this.fetchGlobalSettings=u(this.fetchGlobalSettings,this),this.enterSettingsPage=u(this.enterSettingsPage,this),this.exitSecretMode=u(this.exitSecretMode,this),this.enterSecretMode=u(this.enterSecretMode,this),this.switchProxy=u(this.switchProxy,this),this.reapplyProxy=u(this.reapplyProxy,this),this.updateProxyStatus=u(this.updateProxyStatus,this),this.fetchData=u(this.fetchData,this),this.fixTheMotherfuckerChromeBug=u(this.fixTheMotherfuckerChromeBug,this),this.initUI=u(this.initUI,this);var t;i.__super__.constructor.apply(this,arguments),this.sandbox=new SandBoxCtrl("#sandbox"),this.sandbox.register(),this.state=!1,t=[],t.push(function(t){return function(){return t.initUI(function(){return $(window).dequeue("init")})}}(this)),t.push(function(t){return function(){return t.fetchData(function(){return $(window).dequeue("init")})}}(this)),t.push(function(t){return function(){return t.updateState(function(){return $(window).dequeue("init")})}}(this)),t.push(function(t){return function(){return t.setPaveoDefault(function(){return $(window).dequeue("init")})}}(this)),t.push(function(t){return function(){return t.checkSecretMode(function(){return $(window).dequeue("init")})}}(this)),t.push(function(t){return function(){return t.fetchGlobalSettings(function(){return $(window).dequeue("init")})}}(this)),t.push(function(t){return function(){return t.fixTheMotherfuckerChromeBug(function(){return $(window).dequeue("init")})}}(this)),$(window).queue("init",t),$(window).dequeue("init")}return a(i,t),i.prototype.events={"change #proxy_switch":"switchProxy","click #secret_mode_button":"enterSecretMode","click #paveo_fetch_button":"updatePaveoProfileList","click #paveo_back_button":"exitSecretMode","click #proxy_brand":"startSpeedTest","click #settings_button":"enterSettingsPage","click #settings_back_button":"exitSettingsPage","click #settings_save_button":"saveGlobalSettings","click #settings_reset_button":"fetchGlobalSettings"},i.prototype.elements={"#proxy_switch":"proxySwitch","#speed_test_button":"speedTestButton","#secret_mode_button":"secretModeButton","#sec_mode_username_entry":"secUsernameEntry","#sec_mode_password_entry":"secPasswordEntry","#global_bypass_settings":"globalBypassSettings","#global_bypass_swtich":"globalBypassSwitch","#ignore_bypass_swtich":"ignoreBypassSwitch","#paveo_fetch_button":"pgayFetchButton","#proxy_status":"proxyStatus"},i.prototype.initUI=function(t){return this.sandbox.ready?(Logging.info("Init UI"),this.profileList=new ProfileList({el:$("#profile_list"),sandbox:this.sandbox,parentCtrl:this}),this.profileDetail=new ProfileDetail({el:$("#profile_detail_page"),sandbox:this.sandbox}),this.ignoreBypassSwitch.click(function(t){return function(e){var n;return n=t.ignoreBypassSwitch.prop("checked"),t.ignoreBypassSwitch.closest(".label").val(n?"Send all traffic including":"Send all traffic except")}}(this)),$(window).keypress(function(t){return function(e){if(!document.activeElement||"BODY"===document.activeElement.tagName)switch(e.keyCode){case 111:return app.switchPage("settings");case 97:return app.switchPage("list",!0),t.profileList.addProfile()}}}(this)),Logging.info("Init Keyboard Listeners"),t()):setTimeout(function(e){return function(){return e.initUI(t)}}(this),100)},i.prototype.fixTheMotherfuckerChromeBug=function(t){var e,n;return document.activeElement&&document.activeElement.blur(),window.outerHeight<170?(e=window.outerHeight,n=$("html").width(),$("html").width(n-1e-4),setTimeout(function(t){return function(){return $("html").width(n),Logging.info("outerHeight too small, changed from "+e+" to "+window.outerHeight)}}(this),200)):void 0},i.prototype.fetchData=function(t){return Logging.info("Fetch data from storage"),Profile.fetch(),t()},i.prototype.updateProxyStatus=function(){return this.profileList.getEl().find(".status").html(""),this.state?(this.profileList.getCurrentEl().find(".status").html("Connected"),this.profileList.getEl().find("span.sup").hide(),this.profileList.getCurrentEl().find("span.sup").show()):this.profileList.getEl().find("span.sup").show()},i.prototype.reapplyProxy=function(){return this.proxySwitch.prop("checked")?(Agent.disable(),this.state=!1,setTimeout(function(t){return function(){return Agent.enable(t.profileList.getCurrent()),t.state=!0}}(this),200)):void 0},i.prototype.switchProxy=function(t){return this.proxySwitch.prop("checked")?(Agent.enable(this.profileList.getCurrent()),this.state=!0):(Logging.info("Disable all proxies."),Agent.disable(),this.state=!1),this.updateProxyStatus()},i.prototype.enterSecretMode=function(){return app.switchPage("paveo")},i.prototype.exitSecretMode=function(){return app.switchPage("list")},i.prototype.enterSettingsPage=function(){return app.switchPage("settings")},i.prototype.fetchGlobalSettings=function(t){var e;return e=localStorage.getItem("Settings"),e&&(e=JSON.parse(e),e.bypass&&this.globalBypassSettings.val(e.bypass),this.globalBypassSwitch.attr("checked",e.enableBypass?!0:!1),this.ignoreBypassSwitch.attr("checked",e.ignoreBypass?!0:!1)),t()},i.prototype.saveGlobalSettings=function(){var t;return t=localStorage.getItem("Settings"),t&&(t=JSON.parse(t)),t||(t={}),t.bypass=this.globalBypassSettings.val().trim(),t.enableBypass=!0,t.ignoreBypass="checked"===this.ignoreBypassSwitch.attr("checked"),localStorage.setItem("Settings",JSON.stringify(t)),app.switchPage("list"),this.reapplyProxy()},i.prototype.exitSettingsPage=function(){return this.fetchGlobalSettings(function(t){return function(){return app.switchPage("list")}}(this))},i.prototype.batchAddProfile=function(t,e){var n,i,r,s,o,u;"string"==typeof t&&(t=t.split(",")),o=[];for(i in e)u=e[i],r=""+i,s=null,s=Profile.getByName(r),s=0===s.length?new Profile:s[0],s.name=r,s.type="manual",s.scheme="https",s.pac_url="",s.host=u.host,s.port=u.port,s.testlink=u.testlink,s.rate||(s.rate=""),s.ping||(s.ping=""),n="string"==typeof u.bypass?u.bypass.split(","):t,this.globalBypassSettings.val(n),this.saveGlobalSettings(),u.use_auth?(s.use_auth=u.use_auth,s.username=u.username,s.password=u.password):this.secUsernameEntry&&this.secUsernameEntry.val()?(s.use_auth=!0,s.username=this.secUsernameEntry.val(),s.password=this.secPasswordEntry.val()):s.use_auth=!1,o.push(s.save());return o},i.prototype.fetchPaveo=function(t,e,n){return this.doRequest("POST",t,{user:this.secUsernameEntry.val(),pass:this.secPasswordEntry.val()},{},function(t){return t=JSON.parse(t),e(t)},function(){return n()})},i.prototype.purgeProfiles=function(t){var e,n,i;"string"==typeof t&&(t=[t]),i=[];for(e in t)n=t[e],i.push(Profile.each(function(t){return function(t){return 0===t.name.indexOf(n)?Profile.destroy(t.id):void 0}}(this)));return i},i.prototype.setPaveoDefault=function(t){var e;return e=localStorage.getItem("Defaults"),Logging.info("Try to get default proxies"),this.fetchPaveo("paveo_defaults.json",function(n){return function(i){var r,s,o;return o=!1,s=localStorage.getItem("lastVersion"),r=chrome.app.getDetails().version,s||(s=null),e!==JSON.stringify(i)?(Logging.info("Default proxies has been changed, need to reload"),o=!0):r!==s&&(Logging.info("Version has been changed, need to reload"),localStorage.setItem("version",r),o=!0),o&&(i.purge&&n.purgeProfiles(i.purge),localStorage.setItem("Defaults",JSON.stringify(i)),n.batchAddProfile(i.bypasslist,i.proxies),setTimeout(function(){return Profile.fetch()},200)),t()}}(this),function(e){return function(e,n,i){return Logging.info("No default proxies"),t()}}(this))},i.prototype.checkSecretMode=function(t){return Logging.info("Try to access secret mode"),this.doRequest("GET","secret_mode.json",null,{},function(e){return function(n){return e.secretModeButton.show(),t()}}(this),function(e){return function(e,n,i){return Logging.info("No secret mode"),t()}}(this))},i.prototype.updatePaveoProfileList=function(){var t;return t=function(t){return function(){return t.pgayFetchButton.val("Update"),t.pgayFetchButton.attr("disabled",!1)}}(this),this.pgayFetchButton.attr("disabled",!0),this.pgayFetchButton.val("Updating ..."),this.fetchPaveo("https://api.edgessl.com/ssledge/gpn.php",function(e){return function(n){return e.batchAddProfile(n.bypasslist,n.proxies),setTimeout(function(){return t(),Profile.fetch(),app.switchPage("list")},200)}}(this),function(e){return function(e,i,r){return t(),Logging.error("failed to Authorize."),n("Incorrect username or password")}}(this))},i.prototype.hidePage=function(){return this.el.find(".page:visible").hide()},i.prototype.switchPage=function(t,e){var n,i;if((!this.currentPage||this.currentPage!==t)&&(this.currentPage=t,i=this.el.find(".page:visible"),n=$("#profile_"+t+"_page"),i.attr("id")!==n.attr("id")))return $("#error").hide(),e?(i.hide(),n.show()):(i.slideUp(),n.slideDown())},i.prototype.updateState=function(t){return Logging.info("Update proxy status"),chrome.proxy.settings.get({incognito:!1},function(e){return function(n){var i;return i=!1,n||(e.proxySwitch.attr("checked",!1).prop("checked",!1),i=!0),n&&"controlled_by_this_extension"===n.levelOfControl&&(e.proxySwitch.attr("checked",!0).prop("checked",!0),i=!0),n&&"controllable_by_this_extension"===n.levelOfControl&&(e.proxySwitch.attr("checked",!1).prop("checked",!1),i=!0),i?n&&"direct"===n.value.mode&&e.proxySwitch.attr("checked",!1).prop("checked",!1):e.proxySwitch.attr({disabled:!0,checked:!1}).prop({disabled:!0,checked:!1}),e.state=e.proxySwitch.prop("checked"),e.updateProxyStatus(),t()}}(this))},i.prototype.doRequest=function(t,e,n,i,r,s){return jQuery.ajax({type:t,url:e,processData:null!==n,data:n,beforeSend:function(t){var e,n;for(e in i)n=i[e],t.setRequestHeader(e,n);return t.overrideMimeType("text/plain; charset=x-user-defined")},success:function(t){return r(t)},error:function(t,e,n){return s(t,e,n)}})},i.prototype.fakeHTTPAuth=function(t,n,i){var r;return Logging.info("Test Authorization"),r={Authorization:e(t.username,t.password)},this.doRequest("GET","http://google.com",{rnd:Math.random()},r,function(t){return n?n(t):void 0},function(t,e,n){return Logging.error("Failed to Authorize"),i?i(t,e,n):void 0})},i.prototype.speedTestInProgress=!1,i.prototype.startSpeedTest=function(){var t,e,n,i,r,u,a,c,h;if(console.log(this),!this.speedTestInProgress){for(this.speedTestInProgress=!0,a=!1,r=[],t=function(t){return function(e,n){return r.push(function(){return t.profileList.setPingText(e,"..."),o(n,function(n,i){return-1===n?t.profileList.setPingText(e,"??"):(Logging.info(e+", "+n+", "+i+" kb/s"),t.profileList.setPingText(e,(n/1e3).toFixed(2)+"s"),t.profileList.setRateText(e,", "+i+"kb/s")),$(window).dequeue("_test_speed")})})}}(this),e=function(t){return function(e,n,i){return r.push(function(){return t.profileList.setPingText(e,"..."),o(n,function(n,r){return-1===n?t.profileList.setPingText(e,"??"):t.profileList.setPingText(e,(n/1e3).toFixed(2)+"s"),t.profileList.setRateText(e,", testing ..."),s(i,function(i,r){return Logging.info(e+", "+n+", "+i+", "+r+"kb/s"),-1===i?t.profileList.setRateText(e,", ??"):t.profileList.setRateText(e,", "+r+"kb/s"),$(window).dequeue("_test_speed")})})})}}(this),this.proxySwitch.hasClass("on")===!0&&(a=!0),a&&r.push(function(t){return function(){return t.proxySwitch.hasClass("on")||t.proxySwitch.addClass("on"),$(window).dequeue("_test_speed")}}(this)),c=Profile.all(),n=0,i=c.length;i>n;n++)u=c[n],"manual"!==u.type||"http"!==u.scheme&&"https"!==u.scheme?(this.profileList.setPingText(name,"??"),this.profileList.setRateText(name,"")):(this.profileList.setPingText(name,"waiting ..."),this.profileList.setRateText(name,""),h=u.scheme+"://"+u.host+":"+u.port,u.testlink?e(u.name,h,u.testlink):t(u.name,h));return a&&r.push(function(t){return function(){return t.proxySwitch.hasClass("on")||t.proxySwitch.addClass("on"),$(window).dequeue("_test_speed")}}(this)),r.push(function(t){return function(){return t.speedTestInProgress=!1,$(window).dequeue("_test_speed")}}(this)),$(window).queue("_test_speed",r),$(window).dequeue("_test_speed")}},i}(Spine.Controller),window.app=null,$(document).ready(function(){return window.app=new t({el:$("body")})}),r=function(){return $("#test_speed_button").click(function(){})}}).call(this);